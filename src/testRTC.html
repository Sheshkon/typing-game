<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>WebRTC чат по одной ссылке</title>
    <style>
        body { font-family: sans-serif; }
        #chat { border: 1px solid #ccc; padding: 10px; width: 400px; height: 200px; overflow-y: auto; margin-bottom: 10px; }
    </style>
</head>
<body>
<h3>WebRTC чат</h3>
<p id="status">Статус: подключение...</p>
<div id="chat"></div>
<input id="msg" placeholder="Введите сообщение">
<button id="send">Отправить</button>

<script>
    const params = new URLSearchParams(location.search);
    let roomId = params.get('room');

    if (!roomId) {
        roomId = Math.random().toString(36).substr(2, 8);
        const newUrl = location.origin + location.pathname + "?room=" + roomId;
        document.body.insertAdjacentHTML('afterbegin', `<p>Отправь другу: <a href="${newUrl}">${newUrl}</a></p>`);
    }

    const ws = new WebSocket(`ws://${location.hostname}:8080`);
    const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
    let channel;
    let pendingCandidates = [];

    function log(msg, from="system") {
        const div = document.createElement('div');
        div.textContent = `[${from}] ${msg}`;
        document.getElementById('chat').appendChild(div);
        document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
    }

    pc.oniceconnectionstatechange = () => {
        console.log("ICE state:", pc.iceConnectionState);
    };

    ws.onopen = () => {
        ws.send(JSON.stringify({ join: roomId }));
    };

    ws.onmessage = async e => {
        const data = JSON.parse(e.data);

        if (data.sdp) {
            await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));

            // Добавляем отложенные ICE
            for (const c of pendingCandidates) {
                await pc.addIceCandidate(c);
            }
            pendingCandidates = [];

            if (data.sdp.type === 'offer') {
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                ws.send(JSON.stringify({ sdp: pc.localDescription }));
            }
        } else if (data.candidate) {
            if (!pc.remoteDescription) {
                pendingCandidates.push(data.candidate);
            } else {
                await pc.addIceCandidate(data.candidate);
            }
        }
    };

    pc.onicecandidate = e => {
        if (e.candidate) {
            ws.send(JSON.stringify({ candidate: e.candidate }));
        }
    };

    pc.ondatachannel = e => {
        channel = e.channel;
        setupChannel();
    };

    function setupChannel() {
        channel.onmessage = ev => log(ev.data, "remote");
        channel.onopen = () => {
            document.getElementById('status').textContent = "Соединение установлено!";
            setInterval(() => {
                const msg = "ping " + new Date().toLocaleTimeString();
                channel.send(msg);
                log(msg, "me");
            }, 1000);
        };
    }

    async function start() {
        if (!params.get('room')) {
            channel = pc.createDataChannel("chat");
            setupChannel();

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            ws.send(JSON.stringify({ sdp: pc.localDescription }));
        }
    }

    document.getElementById('send').onclick = () => {
        const text = document.getElementById('msg').value;
        if (channel && channel.readyState === "open") {
            channel.send(text);
            log(text, "me");
            document.getElementById('msg').value = "";
        }
    };

    start();
</script>
</body>
</html>
